# Task 152: 메이크샵 API 호출 예산 산정 및 캐싱 전략

> **작성일**: 2026-02-21
> **Task**: Task 152
> **상태**: 분석 완료
> **주도 에이전트**: makeshop-planning-expert
> **의존성**: Task 150 (적립금 API 검증 완료), Task 151 (가상태그/옵션 검증 완료)

---

## 1. 메이크샵 API 제한 사양

| 구분 | 한도 | 카운트 방식 | 비고 |
|------|------|-----------|------|
| **조회 API** (`open_api.html`) | 500회/시간 | 모든 조회 합산 | 상품/회원/주문/카테고리 등 |
| **처리 API** (`open_api_process.html`) | 500회/시간 | 권한별 별도 카운트 | 적립금/회원/상품 등 |

**핵심 원칙**: 조회와 처리는 **별도 카운트**이므로, 조회 500회 + 처리 500회 = 총 1,000회/시간이 사용 가능하다.

---

## 2. 현재 운영 서비스 API 호출 분석

### 2.1 유튜브 v4 GAS (`youtube-proxy-v3.gs`)

| 호출 대상 | 메이크샵 API 사용 | 상세 |
|----------|-----------------|------|
| YouTube Data API v3 | **아님** | Google API |
| YouTube RSS 피드 | **아님** | YouTube 서버 |
| Google Sheets (카테고리키워드) | **아님** | Google Sheets |
| Google Sheets (카테고리상품) | **아님** | Google Sheets |

**결론: 메이크샵 API 호출 0회/시간**

상품 데이터(branduid, 상품명, 가격, 이미지)는 Google Sheets에 수동으로 관리되며, 메이크샵 API를 통한 실시간 조회가 아니다. GAS CacheService 5분 캐싱은 YouTube API + Sheets 읽기를 캐싱하는 것이지, 메이크샵 API를 캐싱하는 것이 아니다.

### 2.2 파트너맵 GAS (`Code-final.gs`)

| 호출 대상 | 메이크샵 API 사용 | 상세 |
|----------|-----------------|------|
| Google Sheets (설문지 응답 시트1) | **아님** | Google Sheets |
| Google Maps Geocoding | **아님** | Google Maps API |

**결론: 메이크샵 API 호출 0회/시간**

파트너 데이터는 Google Sheets(설문지 응답)에서 직접 읽어서 JSON으로 반환한다. 메이크샵 API와 무관하다.

### 2.3 현재 운영 서비스 합산

| 서비스 | 조회 API (회/시간) | 처리 API (회/시간) |
|--------|-------------------|-------------------|
| 유튜브 v4 GAS | 0 | 0 |
| 파트너맵 GAS | 0 | 0 |
| **현재 합계** | **0** | **0** |

**현재 상태: 메이크샵 API를 전혀 사용하지 않고 있다.** 500회/시간 전체가 Phase 2에서 사용 가능하다.

---

## 3. Phase 2 클래스 플랫폼 API 호출 예상량

### 트래픽 가정

| 지표 | 일반 시간대 | 피크 시간대 (평일 오후/주말) | 비고 |
|------|-----------|-------------------------|------|
| 시간당 방문자 | 10명 | 20명 | foreverlove.co.kr 규모 기준 |
| 시간당 예약 | 1~2건 | 3~5건 | 초기 운영 기준 |
| 활성 파트너 | 5명 | 10명 | 대시보드 접속 기준 |
| 신규 클래스 등록 | 0~1건/일 | 1~2건/일 | |

### 3.1 서비스별 호출량 산정 (조회 API)

#### A. 클래스 목록 조회

| 항목 | 호출 대상 | 호출 횟수 | 캐싱 전략 | 실제 호출 |
|------|----------|----------|----------|----------|
| 클래스(상품) 목록 | `search_product` | 페이지 로드마다 | GAS CacheService 1h | **1회/시간** |
| 카테고리 목록 | `search_category` | 페이지 로드마다 | GAS CacheService 24h | **~0회/시간** (일 1회) |

**소계: 1회/시간 (조회)**

상품 목록 데이터는 GAS에서 1시간 캐싱한다. 프론트엔드에서 GAS를 호출하고, GAS가 캐시 미스일 때만 메이크샵 API를 호출한다. 카테고리는 거의 변하지 않으므로 24시간 캐싱한다.

#### B. 클래스 상세 조회

| 항목 | 호출 대상 | 호출 횟수 | 캐싱 전략 | 실제 호출 |
|------|----------|----------|----------|----------|
| 상품 상세 | `search_product` (branduid) | 상세 페이지 접속마다 | GAS CacheService 1h (상품별) | **최대 10회/시간** |
| 옵션/재고 조회 | 상품 상세에 포함 | 상세 조회에 포함 | 동일 캐시 | 0 (포함됨) |

**소계: 최대 10회/시간 (조회)**

실제로는 인기 클래스 몇 개에 트래픽이 집중되므로, 캐시 히트율이 높다. 10개 이상의 서로 다른 클래스를 1시간 내에 조회하는 경우는 드물다.

#### C. 주문 폴링 (새 주문 감지)

| 항목 | 호출 대상 | 호출 횟수 | 캐싱 전략 | 실제 호출 |
|------|----------|----------|----------|----------|
| 새 주문 조회 | `search_order` | 10분 간격 | 캐싱 불가 (실시간) | **6회/시간** |

**소계: 6회/시간 (조회)**

주문 폴링은 실시간성이 필요하므로 캐싱할 수 없다. 10분 간격(시간당 6회)이 비용 대비 적절한 균형점이다. 15분 간격(4회)으로 줄이면 고객 확인 이메일 발송까지 최대 15분 지연이 발생한다.

#### D. 파트너 인증 (회원 조회)

| 항목 | 호출 대상 | 호출 횟수 | 캐싱 전략 | 실제 호출 |
|------|----------|----------|----------|----------|
| 회원-파트너 매칭 | Sheets 조회 (API 불필요) | 대시보드 접속마다 | GAS 세션 캐시 | **0회/시간** |

**소계: 0회/시간 (조회)**

핵심 포인트: 파트너 인증은 `<!--/user_id/-->` 가상태그에서 얻은 member_id를 GAS로 전달하고, GAS에서 **Google Sheets "파트너 상세" 시트에서 직접 매칭**한다. 메이크샵 회원 조회 API(`search_member`)를 호출할 필요가 없다.

#### E. 정합성 검증 배치

| 항목 | 호출 대상 | 호출 횟수 | 캐싱 전략 | 실제 호출 |
|------|----------|----------|----------|----------|
| 회원 적립금 조회 | `search > user_reserve` | 일 1회 | 캐싱 불필요 | **~2회/시간** (일 1회, 파트너 수에 비례) |
| 상품(클래스) 동기화 | `search_product` | 일 1회 | 캐싱 불필요 | **~1회/시간** (일 1회 배치) |

**소계: ~3회/시간 (일 1회 배치 시간대에만, 나머지 시간 0회)**

정합성 검증은 새벽 3시 등 트래픽이 없는 시간에 실행한다. 활성 파트너 20명의 적립금을 조회해도 `limit=5000` 파라미터로 한 번에 조회 가능하므로 호출 수가 적다.

### 3.2 서비스별 호출량 산정 (처리 API)

#### F. 적립금 지급

| 항목 | 호출 대상 | 호출 횟수 | 캐싱 전략 | 실제 호출 |
|------|----------|----------|----------|----------|
| 수수료 적립금 지급 | `process_reserve` | 주문 확정당 1회 | 캐싱 불가 | **최대 5회/시간** |

**소계: 최대 5회/시간 (처리)**

`datas` 배열을 활용하면 여러 파트너의 적립금을 한 번의 API 호출로 배치 처리할 수 있다. 실제로는 월 정산 시 한 번에 처리하므로 일상적으로는 0회에 가깝다.

#### G. 회원그룹 변경

| 항목 | 호출 대상 | 호출 횟수 | 캐싱 전략 | 실제 호출 |
|------|----------|----------|----------|----------|
| 수강생 그룹 지정 | `process_member` | 신규 수강생당 1회 | 캐싱 불가 | **최대 5회/시간** |

**소계: 최대 5회/시간 (처리)**

#### H. 상품(클래스) 관리

| 항목 | 호출 대상 | 호출 횟수 | 캐싱 전략 | 실제 호출 |
|------|----------|----------|----------|----------|
| 옵션 품절 처리 | `process_product` | 일 1회 배치 | 캐싱 불가 | **~2회/시간** (배치 시간대) |
| 재고(정원) 업데이트 | `process_product` | 예약 확정 시 | 메이크샵 자체 처리 | **0회** (네이티브 결제로 자동 차감) |

**소계: ~2회/시간 (배치 시간대), 0회 (일반 시간대) (처리)**

메이크샵 네이티브 결제를 사용하므로, 옵션(일정) 선택 후 결제 시 재고(정원)는 메이크샵이 자동으로 차감한다. API로 별도 처리할 필요가 없다.

---

## 4. 시나리오별 총 호출량

### 시나리오 A: 현재 운영 서비스만

| 구분 | 조회 API | 처리 API |
|------|---------|---------|
| 유튜브 v4 | 0 | 0 |
| 파트너맵 | 0 | 0 |
| **합계** | **0회/시간** | **0회/시간** |
| **한도 대비** | **0%** | **0%** |

### 시나리오 B: Phase 2 추가 후 (일반 시간대)

| 서비스 | 조회 API | 처리 API | 비고 |
|--------|---------|---------|------|
| 유튜브 v4 | 0 | 0 | Sheets 기반, API 무관 |
| 파트너맵 | 0 | 0 | Sheets 기반, API 무관 |
| 클래스 목록 조회 | 1 | 0 | 1h 캐싱 |
| 클래스 상세 조회 | 10 | 0 | 1h 캐싱, 상품별 |
| 주문 폴링 | 6 | 0 | 10분 간격 |
| 파트너 인증 | 0 | 0 | Sheets 매칭 |
| 적립금 지급 | 0 | 2 | 주문 확정 시 |
| 회원그룹 변경 | 0 | 2 | 신규 수강생 |
| **합계** | **17회/시간** | **4회/시간** |
| **한도 대비** | **3.4%** | **0.8%** |

### 시나리오 C: Phase 2 피크 타임 (주말 오후)

| 서비스 | 조회 API | 처리 API | 비고 |
|--------|---------|---------|------|
| 유튜브 v4 | 0 | 0 | |
| 파트너맵 | 0 | 0 | |
| 클래스 목록 조회 | 2 | 0 | 캐시 만료 시 |
| 클래스 상세 조회 | 20 | 0 | 다양한 클래스 조회 |
| 주문 폴링 | 6 | 0 | 간격 동일 |
| 파트너 인증 | 0 | 0 | Sheets 매칭 |
| 적립금 지급 | 0 | 5 | 피크 예약 |
| 회원그룹 변경 | 0 | 5 | 피크 수강생 |
| 상품 관리 배치 | 0 | 0 | 배치는 새벽에 실행 |
| **합계** | **28회/시간** | **10회/시간** |
| **한도 대비** | **5.6%** | **2.0%** |

### 시나리오 D: 배치 작업 시간대 (새벽 3시)

| 서비스 | 조회 API | 처리 API | 비고 |
|--------|---------|---------|------|
| 정합성 검증 (적립금) | 3 | 0 | 파트너 20명 기준 |
| 상품(클래스) 동기화 | 2 | 0 | 전체 클래스 조회 |
| 옵션 품절 처리 | 0 | 5 | 지난 일정 품절 |
| **합계** | **5회/시간** | **5회/시간** |
| **한도 대비** | **1.0%** | **1.0%** |

### 시나리오 E: 최악의 경우 (B + D 동시 + 수동 작업)

| 구분 | 조회 API | 처리 API |
|------|---------|---------|
| 피크 타임 | 28 | 10 |
| 배치 작업 | 5 | 5 |
| 관리자 수동 조회 | 20 | 5 |
| **합계** | **53회/시간** | **20회/시간** |
| **한도 대비** | **10.6%** | **4.0%** |

---

## 5. 서비스별 예산 배분

### 5.1 조회 API 예산 (500회/시간)

| 서비스 | 할당 | 실사용 (일반) | 실사용 (피크) | 비고 |
|--------|------|-------------|-------------|------|
| 클래스 목록 조회 | 10회 | 1회 | 2회 | 1h 캐싱 |
| 클래스 상세 조회 | 30회 | 10회 | 20회 | 1h 캐싱, 상품별 |
| 주문 폴링 | 10회 | 6회 | 6회 | 10분 간격 고정 |
| 정합성 검증 배치 | 10회 | 0회 | 0회 | 새벽 배치 |
| 상품 동기화 배치 | 5회 | 0회 | 0회 | 새벽 배치 |
| 관리자 수동 | 30회 | 5회 | 20회 | 어드민 작업 |
| **Phase 2 소계** | **95회** | **22회** | **48회** | |
| **여유분** | **405회** | **478회** | **452회** | Phase 3, 긴급용 |
| **합계** | **500회** | - | - | |

### 5.2 처리 API 예산 (500회/시간)

| 서비스 | 할당 | 실사용 (일반) | 실사용 (피크) | 비고 |
|--------|------|-------------|-------------|------|
| 적립금 지급 | 20회 | 2회 | 5회 | 주문 확정 시 |
| 회원그룹 변경 | 20회 | 2회 | 5회 | 신규 수강생 |
| 상품 관리 배치 | 10회 | 0회 | 0회 | 새벽 배치 |
| 관리자 수동 | 20회 | 2회 | 5회 | 어드민 작업 |
| **Phase 2 소계** | **70회** | **6회** | **15회** | |
| **여유분** | **430회** | **494회** | **485회** | Phase 3, 긴급용 |
| **합계** | **500회** | - | - | |

### 5.3 핵심 결론

**Phase 2 운영 시 API 한도의 10% 미만만 사용한다.** 500회/시간 제한은 PRESSCO21 규모에서 충분히 여유 있다. 이 여유분은 Phase 3(리뷰 허브, 수업 기획 도우미)에서 활용 가능하다.

---

## 6. 데이터 유형별 캐싱 전략

### 6.1 정적 데이터 (24시간 캐싱)

변경 빈도가 매우 낮아 하루 1회 갱신으로 충분한 데이터.

| 데이터 | 현재 저장소 | 캐싱 계층 | 갱신 주기 |
|--------|-----------|----------|----------|
| 카테고리 목록 | 메이크샵 | GAS CacheService (24h) | 일 1회 배치 |
| 파트너 목록 | Google Sheets | GAS CacheService (24h) | Sheets 변경 시 자동 |
| 파트너 등급/프로필 | Google Sheets | GAS CacheService (24h) | 관리자 수동 변경 시 |
| 카테고리 키워드 테이블 | Google Sheets | GAS CacheService (5m) -> 24h 권장 | Sheets 변경 시 |
| 카테고리별 상품 목록 | Google Sheets | GAS CacheService (5m) -> 24h 권장 | Sheets 변경 시 |

### 6.2 반정적 데이터 (1시간 캐싱)

하루 몇 번 변경될 수 있으나, 1시간 내 변경이 반영되면 충분한 데이터.

| 데이터 | 현재 저장소 | 캐싱 계층 | 갱신 주기 |
|--------|-----------|----------|----------|
| 클래스(상품) 목록 | 메이크샵 + Sheets | GAS CacheService (1h) + 프론트 localStorage (1h) | API 조회 1회/시간 |
| 클래스 상세 (상품별) | 메이크샵 + Sheets | GAS CacheService (1h) | 상품별 캐시 키 |
| 클래스 메타데이터 | Google Sheets | GAS CacheService (1h) | 커리큘럼/강사소개 등 |
| YouTube 영상 목록 | YouTube API | GAS CacheService (5m) | 이미 구현 완료 |

### 6.3 실시간 데이터 (캐싱 불가 또는 매우 짧은 캐시)

즉시성이 요구되어 캐싱하면 안 되는 데이터.

| 데이터 | 현재 저장소 | 캐싱 전략 | 비고 |
|--------|-----------|----------|------|
| 주문 내역 (폴링) | 메이크샵 | **캐싱 불가** | 10분 간격 직접 조회 |
| 적립금 지급 | 메이크샵 | **캐싱 불가** | 처리 API, 즉시 반영 |
| 회원그룹 변경 | 메이크샵 | **캐싱 불가** | 처리 API |
| 옵션 재고(정원) | 메이크샵 | **짧은 캐시 (5분)** | 결제 시 자동 차감, 상세 조회에 포함 |
| 파트너 인증 결과 | GAS + Sheets | **세션 캐시 (30분)** | 로그인 세션 동안 유지 |

---

## 7. GAS CacheService + localStorage 조합 전략

### 7.1 2계층 캐싱 아키텍처

```
[프론트엔드 브라우저]           [GAS 서버]               [메이크샵 API]
       |                          |                         |
  localStorage                GAS CacheService           원본 데이터
  (1계층 캐시)               (2계층 캐시)              (3계층 원본)
       |                          |                         |
  TTL: 1h (클래스)            TTL: 1h (클래스)           500회/시간 제한
  TTL: 24h (카테고리)         TTL: 24h (카테고리)
  TTL: 5m (재고)              TTL: 5m (YouTube)
```

### 7.2 요청 흐름

```
1. 프론트 JS: localStorage 캐시 확인
   -> 히트: 즉시 렌더링 (0ms, API 호출 0회)
   -> 미스: GAS 요청

2. GAS: CacheService 캐시 확인
   -> 히트: JSON 반환 (200~500ms, API 호출 0회)
   -> 미스: 메이크샵 API 호출

3. 메이크샵 API: 원본 데이터 반환
   -> GAS: CacheService에 저장 (TTL별)
   -> 프론트: localStorage에 저장 + 렌더링
```

### 7.3 캐시 키 설계

**GAS CacheService 키:**

| 캐시 키 패턴 | TTL | 용도 |
|-------------|-----|------|
| `class_list_all` | 1h | 전체 클래스 목록 |
| `class_list_{category}` | 1h | 카테고리별 클래스 목록 |
| `class_detail_{branduid}` | 1h | 클래스 상세 (상품별) |
| `category_list` | 24h | 카테고리 목록 |
| `partner_list` | 24h | 파트너 목록 |
| `partner_{member_id}` | 30m | 파트너 인증 결과 |

**프론트 localStorage 키:**

| 캐시 키 패턴 | TTL | 용도 |
|-------------|-----|------|
| `pc21_class_list` | 1h | 클래스 목록 (JSON + timestamp) |
| `pc21_class_{id}` | 1h | 클래스 상세 |
| `pc21_categories` | 24h | 카테고리 목록 |
| `pc21_partner_auth` | 30m | 파트너 인증 결과 |

### 7.4 localStorage 구현 패턴 (Phase 2 프론트엔드 참고용)

```
// 의사 코드 (pseudocode)
FUNCTION getCachedData(key, ttlMs, fetchFn):
    cached = localStorage.getItem(key)
    IF cached:
        parsed = JSON.parse(cached)
        IF (now - parsed.timestamp) < ttlMs:
            RETURN parsed.data    // 캐시 히트
    // 캐시 미스 -> GAS 호출
    data = AWAIT fetchFn()
    localStorage.setItem(key, JSON.stringify({
        data: data,
        timestamp: now
    }))
    RETURN data
```

### 7.5 캐시 무효화 전략

| 상황 | 무효화 방법 |
|------|-----------|
| 관리자가 클래스 정보 수정 | GAS에서 해당 캐시 키 삭제 (clearCache 엔드포인트) |
| 사용자가 결제 완료 | 해당 클래스 상세 캐시만 무효화 (재고 변동) |
| 파트너 등급 변경 | 해당 파트너 캐시 삭제 |
| 강제 갱신 필요 | 프론트에서 `?force=1` 파라미터로 캐시 우회 |
| 일괄 무효화 | GAS `clearAllCache()` 함수 (관리자 도구) |

---

## 8. GAS 주문 폴링 설계

### 8.1 폴링 간격 결정

| 간격 | 시간당 호출 | 최대 지연 | 권장 여부 | 사유 |
|------|-----------|----------|----------|------|
| 5분 | 12회 | 5분 | 비권장 | 과도한 호출, 초기 규모에 불필요 |
| **10분** | **6회** | **10분** | **권장** | 비용/응답성 최적 균형 |
| 15분 | 4회 | 15분 | 차선 | 고객 이메일 지연 체감 |
| 30분 | 2회 | 30분 | 비권장 | 지연 과도 |

**결정: 10분 간격 (시간당 6회)**

### 8.2 폴링 로직 설계

```
// GAS 시간 트리거 (10분 간격) - 의사 코드

FUNCTION pollNewOrders():
    lastPollTime = Sheets("시스템설정").getRange("마지막폴링시각").getValue()
    now = new Date()

    // 메이크샵 주문 조회 API
    orders = callMakeshopAPI("search_order", {
        start_date: lastPollTime,
        end_date: now,
        order_status: "입금확인"  // 결제 완료 상태
    })

    FOR EACH order IN orders:
        IF isClassProduct(order.branduid):
            // 1. Sheets "예약 내역"에 기록
            recordReservation(order)
            // 2. 수강생 확인 이메일
            sendStudentConfirmation(order)
            // 3. 파트너 알림 이메일
            sendPartnerNotification(order)
            // 4. 수수료 계산 + Sheets "정산 내역" 기록
            calculateCommission(order)

    // 마지막 폴링 시각 업데이트
    Sheets("시스템설정").getRange("마지막폴링시각").setValue(now)
```

### 8.3 클래스 상품 식별

주문 폴링 시 "일반 상품 주문"과 "클래스 예약 주문"을 구분해야 한다.

| 방법 | 설명 | 장점 | 단점 |
|------|------|------|------|
| **카테고리 기반** | 클래스 전용 카테고리 생성 | 단순, 확실 | 카테고리 하드코딩 |
| **상품코드 접두어** | branduid가 "CLASS_"로 시작 | 유연 | 등록 시 규칙 준수 필요 |
| **Sheets 매핑** | Sheets "클래스 메타"에 등록된 branduid만 클래스 | 가장 유연 | Sheets 조회 1회 추가 |

**권장: Sheets 매핑 방식** -- GAS에서 "클래스 메타" 시트를 메모리에 캐시해두고, 주문의 branduid가 클래스 메타에 존재하는지 확인한다. 추가 API 호출이 불필요하다.

---

## 9. 위험 완화 방안

### 9.1 API 호출 모니터링

| 모니터링 항목 | 임계값 | 조치 |
|-------------|-------|------|
| 시간당 조회 API 호출 | 80% (400회) | 관리자 이메일 경고 |
| 시간당 처리 API 호출 | 80% (400회) | 관리자 이메일 경고 |
| 단일 서비스 과다 호출 | 할당량의 150% | 해당 서비스 캐시 TTL 연장 |
| API 응답 에러율 | 10% 이상 | GAS 로그 + 관리자 알림 |

### 9.2 GAS 호출 카운터 구현

```
// GAS에서 API 호출 시마다 카운터 증가 - 의사 코드

FUNCTION trackAPICall(type, service):
    hour = getCurrentHourKey()  // "2026-02-21-14" 형식
    sheet = getSheet("API모니터링")

    // 현재 시간대 카운터 증가
    currentCount = sheet.getRange(hour, type).getValue() + 1
    sheet.getRange(hour, type).setValue(currentCount)

    // 임계값 체크
    IF currentCount >= 400:
        sendAdminAlert("API 호출 80% 도달: " + type + " " + currentCount + "/500")

    // 서비스별 기록
    logToSheet("API호출로그", {
        timestamp: now,
        type: type,
        service: service,
        hourlyCount: currentCount
    })
```

### 9.3 자동 방어 메커니즘

| 상황 | 자동 대응 |
|------|----------|
| 조회 400회/시간 도달 | 캐시 TTL 2배 연장 (1h -> 2h) |
| 조회 450회/시간 도달 | 주문 폴링 간격 30분으로 확대 |
| 처리 400회/시간 도달 | 적립금 지급을 큐에 저장, 다음 시간에 처리 |
| API 응답 에러 | 3회 재시도 (지수 백오프: 1초, 2초, 4초) |
| API 완전 장애 | GAS에서 에러 로그 기록, 관리자 이메일, Sheets 데이터로 폴백 |

### 9.4 Phase 3 확장 시 예산 영향

| 서비스 (Phase 3) | 추가 조회 | 추가 처리 | 비고 |
|-----------------|----------|----------|------|
| 리뷰 허브 | +5회/시간 | +5회/시간 | 리뷰 인센티브 적립금 |
| 수업 기획 도우미 | +2회/시간 | 0 | 상품(재료) 조회 |
| 리뷰 위젯 | 0 | 0 | Sheets 기반, API 무관 |
| **Phase 3 소계** | **+7회/시간** | **+5회/시간** | |
| **Phase 2+3 합계** | **~35회/시간** | **~15회/시간** | |
| **한도 대비** | **7.0%** | **3.0%** | **충분한 여유** |

---

## 10. 요약 및 결론

### 10.1 핵심 발견

1. **현재 메이크샵 API 사용량은 0회/시간이다.** 유튜브 v4와 파트너맵은 Google Sheets 기반으로 메이크샵 API를 사용하지 않는다.

2. **Phase 2 추가 후에도 한도의 10% 미만만 사용한다.** 2계층 캐싱(GAS CacheService + localStorage)과 Sheets 기반 설계 덕분에 실제 API 호출이 극히 적다.

3. **Phase 2+3 모두 완성해도 한도의 7~10% 수준이다.** 500회/시간 제한은 PRESSCO21 규모에서 병목이 되지 않는다.

4. **파트너 인증은 메이크샵 API 호출이 불필요하다.** `<!--/user_id/-->` 가상태그 + Sheets 매칭 방식으로 API 호출 없이 인증 가능하다.

### 10.2 확정 사항

| 항목 | 결정 | 사유 |
|------|------|------|
| 주문 폴링 간격 | **10분** | 비용/응답성 최적 균형 (6회/시간) |
| 클래스 목록 캐시 TTL | **1시간** | 반정적 데이터, 실시간성 불필요 |
| 클래스 상세 캐시 TTL | **1시간** | 상품별 개별 캐시 |
| 카테고리 캐시 TTL | **24시간** | 정적 데이터 |
| 파트너 인증 방식 | **Sheets 매칭** | API 호출 불필요 |
| 적립금 지급 시점 | **주문 확정 시** | 건별 또는 배치(datas 배열) |
| 정합성 검증 시점 | **새벽 3시 배치** | 트래픽 없는 시간대 |
| API 모니터링 | **GAS 카운터 + Sheets 로깅** | 80% 도달 시 경고 |

### 10.3 Phase 2 착수 전제조건 충족 상태

| 전제조건 | 상태 | Task |
|---------|------|------|
| 적립금 API 검증 | 완료 (Plan A 확정) | Task 150 |
| 가상태그 인증 검증 | 완료 (`<!--/user_id/-->` 동작 확인) | Task 151 |
| API 호출 예산 산정 | **완료 (본 문서)** | Task 152 |
| 캐싱 전략 확정 | **완료 (본 문서)** | Task 152 |

**Phase 1.5의 모든 전제조건이 충족되었다. Phase 2 착수 가능하다.**

---

## 11. 이메일 발송 한도 관리

> 협업 에이전트: gas-backend-expert, ecommerce-business-expert 결과 통합

### 11.1 이메일 발송 시뮬레이션

예약 1건당 총 7건 이메일 (예약확인 2 + D-3 리마인더 2 + D-1 리마인더 2 + D+7 후기유도 1)

| 시나리오 | 일일 예약 | 이메일/일 (평균) | 이메일/일 (피크) | 한도 사용률 (피크) |
|---------|--------|---------------|---------------|----------------|
| 초기 운영 (1~2개월) | 2건/일 | 14건 | 20건 | **20%** |
| Phase 2 목표 (3개월) | 3건/일 | 21건 | 30건 | **30%** |
| 안정 운영 (4~5개월) | 5건/일 | 35건 | 50건 | **50%** |
| **전환 경고 시점** | **8건/일** | **56건** | **70건** | **70%** |
| Phase 3 목표 (6개월) | 7건/일 | 49건 | 65건 | **65%** |
| **위험 구간** | **10건/일** | **70건** | **90건** | **90%** |
| 한도 도달 | 14건/일 | 98건 | 100건+ | **100%+** |

> 피크 계수 = 평균의 약 1.35~1.45배 (주말 수업 집중 반영)

**결론: Phase 2 목표(월 50건)와 Phase 3 목표(월 150건)까지 Gmail 무료 계정으로 충분. 월간 예약 200건 돌파 시 Workspace 전환.**

### 11.2 Workspace 전환 시점 권고

| 기준 | 값 | 조치 |
|------|---|------|
| 전환 준비 시작 | 월간 예약 150건 (일평균 6건) | 피크일 50% 도달, 전환 계획 수립 |
| **전환 실행** | **월간 예약 200건 (일평균 8건)** | **피크일 70% 도달, Workspace 전환** |
| 긴급 전환 | 월간 예약 250건 (일평균 10건) | 피크일 90% 도달, 즉각 조치 |

**비용**: Google Workspace Starter 약 8,000원/월 (이메일 100건 -> 1,500건/일, 15배 증가)

> **주의**: GAS 일일 실행 시간 한도. 10분 폴링(72분) + 리마인더(10분) + 정합성 배치(5분) = ~87분으로 개인 계정 한도(90분)에 근접. **Phase 2 시작 시 Workspace 전환을 강력 권장.**

### 11.3 이메일 우선순위 (한도 도달 시)

| 우선순위 | 이메일 유형 | 한도 초과 시 대응 |
|---------|-----------|----------------|
| P0 (필수) | 예약 확인 이메일 (수강생 + 파트너) | 큐잉 후 다음날 새벽 재발송 |
| P1 (중요) | D-1 리마인더 | 큐잉 처리 |
| P2 (보조) | **D-3 리마인더** | **첫 번째 생략 대상** (D-1만으로 커버) |
| P3 (선택) | D+7 후기 유도 | D+14로 연기 가능 |

### 11.4 이메일 카운트 모니터링 GAS 패턴

```
// 의사 코드 (pseudocode)
// 모든 이메일 발송은 이 래퍼를 통해
FUNCTION sendEmailWithTracking(recipient, subject, body):
    today = formatDate(now, 'Asia/Seoul', 'yyyy-MM-dd')
    count = getTodayEmailCount(today)  // email_log 시트에서 읽기

    IF count >= EMAIL_DAILY_LIMIT (100):
        saveFailedEmail(recipient, subject, body, 'DAILY_LIMIT_EXCEEDED')
        RETURN { success: false }

    sendEmail(recipient, subject, body)
    incrementEmailCount(today)  // LockService 사용

    IF count + 1 == 70 (EMAIL_WARNING_THRESHOLD):
        sendAdminEmail('[PRESSCO21] 일일 이메일 70건 도달 - Workspace 전환 검토 필요')

    RETURN { success: true }
```

**email_log 시트 구조**: 날짜 | 발송수 | 경고발송여부 | 한도도달여부

---

## 12. GAS LockService 동시성 처리

> 협업 에이전트: gas-backend-expert 결과

### 12.1 주문 폴링 동시 실행 방지

```
// 의사 코드
FUNCTION pollNewOrders():
    lock = LockService.getScriptLock()
    hasLock = lock.tryLock(0)  // 즉시 시도, 대기 없음

    IF NOT hasLock:
        // 이전 폴링 아직 실행 중 -> 스킵 (다음 트리거에서 처리)
        RETURN

    TRY:
        orders = fetchNewOrders(getLastProcessedTimestamp())
        FOR EACH order: processOrder(order)
        updateLastProcessedTimestamp()
        SpreadsheetApp.flush()
    FINALLY:
        lock.releaseLock()
```

**핵심**: `tryLock(0)` 즉시 포기 패턴 사용. 폴링은 10분 후 다음 트리거에서 재처리 가능하므로 대기 불필요.

### 12.2 예약 기록 쓰기 (중복 방지)

```
// 의사 코드
FUNCTION processOrder(order):
    lock = LockService.getScriptLock()
    lock.waitLock(30000)  // 쓰기는 반드시 성공 -> 최대 30초 대기

    TRY:
        IF isOrderAlreadyProcessed(order.orderId):
            RETURN  // 중복 방지 (멱등성)

        saveReservation(order)      // Sheets 저장
        sendReservationEmails(order) // 이메일 발송
        markOrderProcessed(order.orderId)
        SpreadsheetApp.flush()
    FINALLY:
        lock.releaseLock()
```

**원칙**: 읽기-폴링은 `tryLock(0)`, 쓰기-처리는 `waitLock(30000)`. 적립금 지급 실패 시 **자동 재시도 없음** (이중 지급 방지), 관리자 수동 처리 후 Sheets 상태 업데이트.

---

## 변경 이력

| 날짜 | 내용 |
|------|------|
| 2026-02-21 | 초기 분석 보고서 작성 (Task 152 완료) |
| 2026-02-21 | 이메일 한도 시뮬레이션 + LockService 패턴 추가 (협업 에이전트 결과 통합) |
