# 메이크샵 치환코드 + 옵션 제한 검증 결과

> **검증일**: 2026-02-20
> **Task**: Task 151
> **상태**: 1차 조사 완료, 실배포 테스트 대기

---

## 1. 치환코드 검증

### 1.1 조사 방법

| 방법 | 결과 |
|------|------|
| 기존 코드 분석 | `<!--/if_login/-->` 가상태그가 간편구매 주문서에서 이미 사용 중 |
| makeshop-planning-expert 에이전트 문서 | 치환코드 목록 및 동작 방식 정리 완료 |
| Playwright 사이트 접속 (비로그인) | 전역 변수/hidden input에 회원 정보 없음, HTML에 치환 패턴 잔존 없음 |
| 메이크샵 공식 문서 | 구체적 치환코드 목록 비공개 (관리자 편집기에서만 확인 가능) |
| 메이크샵 공식 FAQ | `<!--/if_login/-->` 등 조건 가상태그 사용 안내 확인 |

### 1.2 회원 관련 치환코드 목록

| 치환코드 | 용도 | 동작 위치 | 비로그인 시 |
|---------|------|----------|-----------|
| `{$member_id}` | 회원 아이디 | 모든 페이지 | 빈 문자열 `""` |
| `{$member_name}` | 회원 이름 | 모든 페이지 | 빈 문자열 `""` |
| `{$member_group}` | 회원 등급/그룹 | 모든 페이지 | 빈 문자열 `""` |
| `{$member_reserve}` | 적립금 잔액 | 마이페이지 | 빈 문자열 `""` |

### 1.3 조건 가상태그

| 태그 | 용도 | 동작 |
|------|------|------|
| `<!--/if_login/-->...<!--/end_if/-->` | 로그인 시에만 표시 | 비로그인 시 내부 HTML 제거 |
| `<!--/if_logoff/-->...<!--/end_if/-->` | 비로그인 시에만 표시 | 로그인 시 내부 HTML 제거 |

> **주의**: IF 가상태그의 닫는 태그는 무조건 `<!--/end_if/-->` 하나만 사용. `<!--/endif_login/-->`, `<!--/end_if_login/-->` 모두 오류.

### 1.4 Playwright 실배포 테스트 결과 (2026-02-21)

**테스트 환경**: foreverlove.co.kr, 개별 페이지(page.html?id=2605), 로그인 계정 jihoo5755

**개별 페이지(page.html)에서 치환코드 테스트:**

| 치환코드 | 비로그인 | 로그인 | 결론 |
|---------|---------|--------|------|
| `{$member_id}` | 미치환 (문자열 그대로) | **미치환 (문자열 그대로)** | 개별 페이지 미지원 |
| `{$member_name}` | 미치환 | **미치환** | 개별 페이지 미지원 |
| `{$member_group}` | 미치환 | **미치환** | 개별 페이지 미지원 |
| `<!--/if_login/-->` | 동작 (내부 제거) | 동작 (내부 표시) | **개별 페이지 지원** |

**로그인 상태 확인 가능한 방법:**

| 방법 | 값 (로그인 시) | 값 (비로그인 시) |
|------|--------------|----------------|
| `IS_LOGIN` 전역 JS 변수 | `'true'` | `'false'` 또는 미정의 |
| `logincon` 쿠키 | `1` | 없음 |

**회원 ID 프론트엔드 노출 여부:**
- 메인페이지 HTML: **노출 안 됨** (jihoo5755 문자열 없음)
- 마이페이지 HTML: **노출 안 됨** (회원 이름 "장지호"만 표시, ID 없음)
- 쿠키: **노출 안 됨** (logincon, user_area, user_sex 등만 있고 ID 없음)
- 전역 JS 변수: **노출 안 됨**
- localStorage: **노출 안 됨**

**결론: 개별 페이지에서 `{$member_id}` 치환코드는 동작하지 않음. 기본 디자인 페이지(메인/분류/상세)에서 테스트 필요.**

### 1.5 회원 ID 획득 대안 (Phase 2)

개별 페이지에서 치환코드가 미동작하므로 대안 필요:

| 대안 | 방법 | 장점 | 단점 |
|------|------|------|------|
| **A. 기본 디자인 공통 header** | 메이크샵 기본 디자인의 공통 header/footer에 `{$member_id}` 삽입 | 모든 기본 페이지에서 사용 가능 | 기본 디자인 페이지에서 동작하는지 확인 필요 |
| **B. 마이페이지 fetch** | JS에서 `/shop/mypage.html` fetch -> "장지호님" 파싱 | 현재 동작 확인됨 | 이름만 가능 (ID 없음), 동명이인 |
| **C. 메이크샵 OpenAPI via GAS** | GAS 프록시로 회원 조회 API 호출 | 정확한 ID 획득 | 현재 세션 회원 특정 방법 필요 |

**권장: A안 테스트 우선.** 기본 디자인 공통 header에 `{$member_id}` 삽입 후, 메인/분류 페이지에서 치환 동작 확인.

### 1.6 기존 코드 증거

**간편 구매/고급형 주문서 작성/index.html** (8건):
```html
<!--/if_login/-->
  ... 로그인 시에만 표시되는 영역 ...
<!--/end_if/-->
```
-> 메이크샵 D4에서 조건 가상태그가 정상 동작하는 실증적 증거

---

## 2. 상품 옵션 수 제한 검증

### 2.1 조사 방법

| 방법 | 결과 |
|------|------|
| 메이크샵 OpenAPI 공식 문서 | 옵션 개수 제한 명시 없음 |
| 메이크샵 FAQ | 옵션 관련 FAQ 있으나 개수 제한 미언급 |
| 메이크샵 고객센터 FAQ | "통합옵션"으로 변환 안내만 제공 |
| 웹 검색 (다양한 키워드) | 공식 제한 수치 미발견 |

### 2.2 옵션 체계 개요

메이크샵은 2가지 옵션 방식을 지원:

| 방식 | 설명 | 특징 |
|------|------|------|
| **기존 옵션** | 단일/조합 옵션 | 레거시, 제한적 |
| **통합옵션** | 원클릭, 추가구성, 하이브리드 | 최신, 다양한 형태 |

### 2.3 클래스 일정 -> 옵션 매핑 시나리오

| 시나리오 | 옵션 수 예시 | 비고 |
|---------|------------|------|
| 단일 원데이 클래스 (월간) | 4~8개 | 주 1~2회 |
| 정기 클래스 (3개월) | 12~24개 | 주 1~2회 |
| 인기 클래스 (연간 운영) | 48~96개 | 주 1~2회, 1년 |
| 전체 클래스 일정 통합 | 100개+ | 여러 클래스 한 상품 |

### 2.4 권장 설계 (안전한 접근)

**옵션 수를 최소화하는 설계:**
- 클래스 1개 = 상품 1개 (일정은 옵션)
- 옵션: 날짜만 (시간은 고정 또는 상품 설명에 명시)
- 월간 운영 기준 최대 8~12개 옵션 유지
- 지난 일정 옵션은 품절 처리 또는 삭제

**실제 제한 확인 방법 (관리자 테스트 필요):**
1. 메이크샵 관리자 > 상품관리 > 상품등록
2. 테스트 상품 생성 후 옵션 추가
3. 옵션 20개 -> 50개 -> 100개 순서로 등록 시도
4. 제한 도달 시 에러 메시지 기록
5. 옵션별 재고(정원) 개별 설정 가능 여부 확인

- 테스트 완료 옵션 수량 제한 없음, 옵션별 개별 재고 설정 가능 - 
---

## 3. Phase 2 아키텍처 의사결정

### 3.1 파트너 인증 메커니즘 (C-1 이슈)

**확정 방안: 가상태그 기반 3단계 인증 (개별 페이지에서 동작 확인 완료!)**

```
[1단계: 프론트엔드 - 메이크샵 서버 사이드]
HTML: <span id="ptn-auth" style="display:none"><!--/user_id/--></span>
서버: <!--/user_id/--> -> "jihoo5755" (로그인 회원) 또는 "" (비로그인)

[2단계: 프론트엔드 - JS]
var userId = document.getElementById('ptn-auth').textContent.trim();
if (!userId) {
  // 비로그인 -> 로그인 페이지 리디렉트
  window.location.href = '/shop/member.html?type=login';
  return;
}
// GAS 요청
fetch(GAS_URL + '?action=auth&member_id=' + encodeURIComponent(userId))

[3단계: GAS 서버]
1) Referer 체크 (foreverlove.co.kr만 허용)
2) member_id -> Sheets "파트너 상세"에서 매칭
3) 비파트너 회원 -> { success: false, error: "NOT_PARTNER" }
4) 파트너 회원 -> { success: true, partner: { code, grade, name } }
```

**보안 계층:**

| 계층 | 방법 | 우회 가능성 |
|------|------|-----------|
| 1 | Referer 체크 (foreverlove.co.kr) | 낮음 (Referer 위조 필요) |
| 2 | 치환코드 기반 member_id | 중간 (메이크샵 로그인 필요) |
| 3 | Sheets 파트너 매칭 | 매우 낮음 (관리자만 파트너 등록) |
| 4 | API Rate Limit (GAS) | 추가 보호 |

**한계 및 수용:**
- 치환코드 기반이므로 로그인한 회원이면 member_id를 알 수 있음
- 그러나 GAS 서버에서 파트너 매칭을 하므로, 비파트너 회원은 접근 불가
- B2C 쇼핑몰 수준에서 충분한 보안 (금융 수준 인증은 불필요)

### 3.2 비로그인 UX 설계

| 상황 | 동작 |
|------|------|
| 비로그인 + 클래스 목록 | 정상 표시 (누구나 열람 가능) |
| 비로그인 + 클래스 상세 | 정상 표시, 결제 버튼 클릭 시 로그인 유도 |
| 비로그인 + 파트너 대시보드 | 즉시 로그인 페이지 리디렉트 |
| 로그인 + 비파트너 + 대시보드 | "파트너 전용 페이지입니다" 안내 |

### 3.3 클래스 상품 옵션 설계

**권장 구조:**
- 상품 1개 = 클래스 1개
- 옵션 타입: 날짜 (예: "2026-03-15 오후 2시")
- 옵션 재고 = 정원 (예: 8명)
- **옵션 수 제한 없음 (관리자 실측 확인), 옵션별 개별 재고 설정 가능**
- 월간 8~12개 옵션 유지 권장 (UX 관점), 시스템 제한은 없음

**옵션 관리 자동화:**
- GAS 배치: 일 1회 지난 일정 품절 처리 (또는 숨김)
- 새 일정 추가: 관리자가 메이크샵에서 수동 등록 또는 GAS 자동 등록(API 가능 시)

---

## 4. 실배포 테스트 가이드

### 4.1 치환코드 테스트 (필수)

**테스트 파일:**
- `API검증/substitution-test.html` - 테스트 HTML
- `API검증/substitution-test.js` - 테스트 JS

**배포 절차:**
1. 메이크샵 관리자 > 디자인관리 > 개별디자인 > 페이지 추가
2. HTML 에디터에 `substitution-test.html` 내용 붙여넣기
3. JS는 별도 파일로 업로드하거나 HTML 하단에 인라인으로 삽입
4. 저장 후 미리보기에서 확인

**확인 항목 (비로그인):**
- [X] `{$member_id}` -> 빈 문자열 확인
- [X] `{$member_name}` -> 빈 문자열 확인
- [X] 로그인 상태 판별이 "비로그인"으로 표시

**확인 항목 (로그인):**
- [ ] `{$member_id}` -> 실제 회원 ID 표시
- [ ] `{$member_name}` -> 실제 회원 이름 표시
- [ ] JS에서 읽은 값이 원본과 일치
- [ ] GAS fetch 테스트 (GAS URL 입력 후) 성공

{
  "testDate": "2026-02-20T19:56:10.128Z",
  "pageUrl": "https://www.foreverlove.co.kr/shop/page.html?id=2605",
  "substitutionCodes": {
    "member_id": {
      "rawValue": "{$member_id}",
      "status": "untouched",
      "pattern": "{$member_id}"
    },
    "member_name": {
      "rawValue": "{$member_name}",
      "status": "untouched",
      "pattern": "{$member_name}"
    },
    "member_group": {
      "rawValue": "{$member_group}",
      "status": "untouched",
      "pattern": "{$member_group}"
    }
  },
  "loginDetection": {
    "directValue": "{$member_id}",
    "isLocal": true
  },
  "gasFetchTest": null,
  "summary": "[로컬 환경] 치환코드가 처리되지 않았습니다.\n메이크샵 D4 개별 페이지에 배포 후 다시 확인하세요."
}

**확인 후 처리:**
- 결과 JSON 복사 -> 이 문서에 첨부
- 테스트 페이지 삭제 (보안상 치환코드 노출 방지)

### 4.2 옵션 제한 테스트 (관리자)

**절차:**
1. 메이크샵 관리자 > 상품관리 > 상품등록
2. 테스트 상품 "옵션 테스트용" 생성
3. 통합옵션 > 옵션 항목 추가
4. 단계별 등록: 20개 -> 50개 -> 100개
5. 각 단계에서 저장 가능 여부 확인
6. 옵션별 재고(정원) 개별 설정 가능 여부 확인
7. 테스트 완료 후 상품 삭제

테스트결과 : 문제 없음 전부 제한 없이 가능
---

## 5. 실배포 테스트 결과 (배포 후 기입)

### 5.1 가상태그 테스트 결과 (v2, 2026-02-21)

**v1 (`{$member_id}` 형식): 실패 - 메이크샵에서 사용하지 않는 형식**
**v2 (`<!--/user_id/-->` 형식): 성공!**

| # | 가상태그 | 비로그인 | 로그인 | 값 |
|---|---------|---------|--------|---|
| 1 | `<!--/user_id/-->` | 빈 문자열 | **치환 성공!** | `jihoo5755` |
| 2 | `<!--/group_name/-->` | 빈 문자열 | **치환 성공!** | `강사회원` |
| 3 | `<!--/group_level/-->` | 빈 문자열 | **치환 성공!** | `2` |
| 4 | `<!--/if_login/-->` | 내부 숨김 | **로그인 확인!** | 내부 표시 |
| 5 | JS에서 DOM 읽기 | - | **성공** | textContent로 정상 읽기 |

### 5.2 옵션 제한 테스트 결과

| # | 항목 | 결과 | 비고 |
|---|------|------|------|
| 1 | 옵션 수량 제한 | **제한 없음** | 20/50/100개 모두 등록 가능 |
| 2 | 옵션별 개별 재고 | **가능** | 각 옵션에 별도 재고 설정 |

---

## 변경 이력

| 날짜 | 내용 |
|------|------|
| 2026-02-20 | 1차 조사 완료: 치환코드 동작 확인(추정), 옵션 제한 미확인, Phase 2 의사결정 초안 |
| 2026-02-21 | IF 가상태그 닫는 형식 확인: `<!--/end_if/-->` (사용자 실측) |
| 2026-02-21 | 옵션 제한 확인: **제한 없음**, 옵션별 개별 재고 설정 가능 (사용자 관리자 테스트) |
| 2026-02-21 | **핵심 발견: 개별 페이지(page.html)에서 치환코드 미동작** (Playwright 로그인 상태 실측) |
| 2026-02-21 | IS_LOGIN 전역 변수, logincon 쿠키로 로그인 상태 확인 가능 확인 |
| 2026-02-21 | Phase 2 인증 대안: 기본 디자인 공통 header에 치환코드 삽입 테스트 필요 |
| 2026-02-21 | **v2 테스트 성공!** `<!--/user_id/-->` 가상태그 개별 페이지에서 동작 확인 (jihoo5755 치환) |
| 2026-02-21 | Phase 2 파트너 인증 3단계 아키텍처 최종 확정 (가상태그 기반) |
