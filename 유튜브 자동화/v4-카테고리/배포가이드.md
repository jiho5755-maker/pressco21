# YouTube v4 카테고리 자동매칭 - 배포 가이드

> **작성일**: 2026-02-20
> **대상**: foreverlove.co.kr (메이크샵 D4 카멜레온)
> **파일 위치**: `유튜브 자동화/v4-카테고리/`

---

## 1. 개요

### v3에서 v4로 업그레이드하는 이유

v3는 단순히 YouTube RSS 피드에서 최신 영상 5개를 가져와 보여주는 방식이었습니다. 관련 상품은 HTML에 직접 하드코딩되어 있어, 새 영상이 올라올 때마다 수동으로 상품을 수정해야 했습니다.

v4는 **영상의 제목, 설명, 태그를 분석하여 카테고리를 자동 감지**하고, 해당 카테고리에 맞는 상품을 Google Sheets에서 동적으로 불러옵니다. 새 영상이 업로드되면 키워드 매칭을 통해 관련 상품이 자동으로 표시됩니다.

### 주요 변경사항 요약

| 항목 | v3 (기존) | v4 (신규) |
|------|----------|----------|
| 관련 상품 | HTML에 수동 하드코딩 | Google Sheets에서 자동매칭 |
| 데이터 소스 | RSS 피드만 사용 | YouTube Data API v3 + RSS 폴백 |
| 영상 메타데이터 | id, title, publishedAt | + tags, viewCount, description |
| 카테고리 | 없음 | 키워드 기반 자동 감지 + 배지 표시 |
| 조회수 표시 | 없음 | K/만 단위 포맷팅 |
| NEW 배지 | 없음 | 3일 이내 영상 자동 표시 |
| 로딩 UI | 없음 | 스켈레톤 shimmer 애니메이션 |
| XSS 방어 | 없음 | escapeHTML/escapeAttr 적용 |
| CSS 클래스 | `.youtube-section-v3` | `.youtube-v4-section` + `ytv4-` 접두사 |
| 캐시 키 | `yt_cache_v3` / `yt_time_v3` | `yt_v4_data` / `yt_v4_time` |
| GAS 캐시 | 없음 | CacheService 5분 캐싱 |

### 시스템 구성도

```
[사용자 브라우저]
    ↓ AJAX 요청
[GAS 웹 앱 (프록시)]
    ├── YouTube Data API v3 → 영상 목록 (제목, 태그, 조회수)
    ├── YouTube RSS 피드 → 폴백 (API 실패 시)
    └── Google Sheets → 키워드-카테고리 매핑 + 카테고리-상품 매핑
    ↓ 통합 JSON 응답
[프론트엔드 JS]
    ├── autoMatchCategory() → 영상별 카테고리 감지
    ├── getProductsForCategory() → 매칭된 상품 표시
    └── localStorage 24시간 캐싱
```

---

## 2. 사전 준비물

시작하기 전에 아래 항목을 모두 준비해야 합니다.

### 2-1. YouTube Data API 키 발급

1. [Google Cloud Console](https://console.cloud.google.com/) 접속
2. 좌측 상단 프로젝트 선택 드롭다운 > **새 프로젝트** 생성 (예: "pressco21-youtube")
3. 좌측 메뉴 > **API 및 서비스** > **라이브러리**
4. 검색창에 "YouTube Data API v3" 입력 > 클릭 > **사용 설정** 버튼 클릭
5. 좌측 메뉴 > **API 및 서비스** > **사용자 인증 정보**
6. 상단 **+ 사용자 인증 정보 만들기** > **API 키**
7. 생성된 API 키를 복사하여 안전한 곳에 보관

**주의:** API 키는 절대 코드에 직접 입력하지 마세요. GAS 스크립트 속성에만 저장합니다.

> **참고 - API 할당량**: YouTube Data API v3의 기본 할당량은 하루 10,000 유닛입니다. `videos.list`는 호출당 약 1 유닛이므로 일반적인 사용에서는 초과 걱정이 없습니다. 만약 초과되면 RSS 폴백이 자동으로 작동합니다.

### 2-2. Google Sheets 스프레드시트 생성

1. [Google Sheets](https://sheets.google.com) 접속
2. **빈 스프레드시트** 생성
3. 스프레드시트 이름 변경 (예: "pressco21-유튜브-상품매핑")
4. 브라우저 URL에서 **스프레드시트 ID** 확인:
   ```
   https://docs.google.com/spreadsheets/d/여기가_스프레드시트_ID/edit
   ```
5. 이 ID를 복사하여 보관

### 2-3. Google Apps Script 프로젝트 생성

1. [script.google.com](https://script.google.com) 접속
2. 좌측 상단 **새 프로젝트** 클릭
3. 프로젝트 이름을 "pressco21-youtube-proxy-v3"로 변경

---

## 3. Step 1: Google Sheets 설정

### 시트1: 카테고리키워드

영상의 제목, 설명, 태그에서 이 키워드가 발견되면 해당 카테고리로 분류됩니다.

1. 스프레드시트의 첫 번째 시트 탭 이름을 **카테고리키워드** 로 변경 (정확히 일치해야 합니다)
2. 아래 구조로 데이터 입력:

| A열 (키워드) | B열 (카테고리) |
|-------------|--------------|
| 키워드 | 카테고리 |
| 압화 | 압화 |
| pressed flower | 압화 |
| pressed | 압화 |
| 보존화 | 보존화 |
| preserved | 보존화 |
| 레진공예 | 레진공예 |
| 레진 | 레진공예 |
| resin | 레진공예 |
| 캔들 | 캔들 |
| candle | 캔들 |
| 석고 | 석고방향제 |
| 방향제 | 석고방향제 |

**주의:** 1행은 반드시 헤더(키워드, 카테고리)여야 합니다. 데이터는 2행부터 입력합니다.

> **팁 - 긴 키워드 우선 매칭**: JS의 `autoMatchCategory()`는 긴 키워드부터 먼저 검사합니다. 예를 들어 "레진공예"가 "레진"보다 먼저 매칭되므로, "레진공예 만들기" 영상이 "레진공예" 카테고리에 정확히 분류됩니다. 따라서 구체적인 키워드와 포괄적인 키워드를 함께 등록해도 안전합니다.

### 시트2: 카테고리상품

각 카테고리별로 추천할 상품 목록입니다.

1. 하단의 **+** 버튼으로 새 시트 추가
2. 시트 탭 이름을 **카테고리상품** 으로 변경 (정확히 일치해야 합니다)
3. 아래 구조로 데이터 입력:

| A열 (카테고리) | B열 (branduid) | C열 (상품명) | D열 (가격) | E열 (이미지URL) |
|--------------|---------------|------------|----------|---------------|
| 카테고리 | branduid | 상품명 | 가격 | 이미지URL |
| 압화 | 1001 | 압화 스타터 키트 | 35000 | https://jewoo.img4.kr/... |
| 압화 | 1002 | 압화 액자 세트 | 28000 | https://jewoo.img4.kr/... |
| 보존화 | 2001 | 보존화 꽃다발 | 45000 | https://jewoo.img4.kr/... |
| default | 9001 | 베스트셀러 1 | 28000 | https://jewoo.img4.kr/... |
| default | 9002 | 베스트셀러 2 | 32000 | https://jewoo.img4.kr/... |
| default | 9003 | 베스트셀러 3 | 25000 | https://jewoo.img4.kr/... |
| default | 9004 | 베스트셀러 4 | 38000 | https://jewoo.img4.kr/... |

**주의:** 1행은 반드시 헤더여야 합니다. 데이터는 2행부터 입력합니다.

**주의:** `default` 카테고리는 **반드시** 설정해야 합니다. 영상의 키워드가 어떤 카테고리와도 매칭되지 않을 때 이 상품들이 표시됩니다. default 상품이 없으면 매칭 실패 시 "관련 상품이 준비 중입니다"라는 메시지만 표시됩니다.

### branduid 확인 방법

메이크샵 관리자에서 상품의 `branduid`를 확인하는 방법:

1. 메이크샵 관리자 > **상품관리** > **상품목록**
2. 해당 상품 클릭
3. 브라우저 URL에서 확인:
   ```
   https://foreverlove.co.kr/admin/shopdetail.html?branduid=여기가_branduid
   ```
4. 또는 상점 프론트에서 상품 페이지 URL 확인:
   ```
   https://foreverlove.co.kr/shop/shopdetail.html?branduid=여기가_branduid
   ```

### 카테고리별 상품 개수

프론트엔드에서는 카테고리당 **최대 4개** 상품을 표시합니다. 5개 이상 등록해도 처음 4개만 표시되므로, 가장 추천하고 싶은 상품 4개를 상단에 배치하세요.

### Step 1 완료 체크리스트

- [ ] 시트1 탭 이름이 정확히 "카테고리키워드"인가?
- [ ] 시트2 탭 이름이 정확히 "카테고리상품"인가?
- [ ] 두 시트 모두 1행이 헤더이고, 데이터는 2행부터 시작하는가?
- [ ] "default" 카테고리에 상품이 최소 1개 이상 등록되어 있는가?
- [ ] 이미지 URL이 유효한 경로인가?
- [ ] branduid가 실제 메이크샵 상품과 일치하는가?
- [ ] 스프레드시트 ID를 복사해 두었는가?

---

## 4. Step 2: GAS 백엔드 배포

### 4-1. 코드 붙여넣기

1. [script.google.com](https://script.google.com) 에서 앞서 생성한 프로젝트 열기
2. 기본 생성된 `코드.gs` 파일의 내용을 **모두 삭제**
3. `youtube-proxy-v3.gs` 파일의 내용을 **전체 복사**하여 붙여넣기
4. 파일 이름은 그대로 `코드.gs`여도 무관 (파일 이름 자체는 동작에 영향 없음)

### 4-2. 스크립트 속성 설정

스크립트 속성은 API 키와 같은 민감 정보를 코드에 직접 넣지 않고 안전하게 저장하는 방법입니다.

1. GAS 편집기 좌측 메뉴에서 **톱니바퀴 아이콘 (프로젝트 설정)** 클릭
2. 아래로 스크롤하여 **스크립트 속성** 섹션 확인
3. **스크립트 속성 추가** 버튼을 클릭하고 다음 2개를 추가:

| 속성 | 값 |
|------|-----|
| `YOUTUBE_API_KEY` | 앞서 발급받은 YouTube Data API v3 키 |
| `SPREADSHEET_ID` | 앞서 생성한 Google Sheets의 스프레드시트 ID |

4. **저장** 버튼 클릭

### 4-3. 설정 확인 (선택 사항)

코드에 포함된 `checkConfig()` 함수로 설정이 올바른지 확인할 수 있습니다:

1. GAS 편집기 상단의 함수 선택 드롭다운에서 **checkConfig** 선택
2. **실행** 버튼 클릭
3. 최초 실행 시 **권한 승인** 요청이 표시됩니다:
   - "이 앱은 확인되지 않았습니다" > **고급** > **프로젝트이름(으)로 이동**
   - 권한 허용
4. 하단 **실행 로그**에서 결과 확인:
   ```
   [OK] YOUTUBE_API_KEY: AIza...
   [OK] SPREADSHEET_ID: 1abc...
   [OK] 시트 목록: 카테고리키워드, 카테고리상품
   ```

**주의:** `[누락]`이 표시되면 해당 속성이 설정되지 않은 것입니다. 4-2 단계를 다시 확인하세요.

### 4-4. 통합 테스트 (선택 사항)

전체 동작을 테스트하려면:

1. 함수 선택 드롭다운에서 **testIntegrated** 선택
2. **실행** 버튼 클릭
3. 실행 로그에서 확인:
   ```
   [RSS] 5개 영상 ID 추출 완료
   [Data API] 5개 영상 상세 정보 (태그 포함) 로드 완료
   [Sheets] 카테고리 키워드 12개 로드 완료
   [Sheets] 카테고리 상품 로드 완료 - 압화:4개, 보존화:3개, default:4개
   영상 수: 5
   첫 영상: ...
   ```

### 4-5. 웹 앱 배포

1. GAS 편집기 우측 상단 **배포** 버튼 > **새 배포**
2. 좌측 톱니바퀴 아이콘 옆 **유형 선택** > **웹 앱** 체크
3. 설정 입력:
   - **설명**: "YouTube Proxy v3 - 카테고리 자동매칭"
   - **다음 사용자 인원으로 실행**: **나** (본인 계정)
   - **액세스 권한이 있는 사용자**: **모든 사용자**
4. **배포** 버튼 클릭
5. **웹 앱 URL**이 표시됩니다. 이 URL을 복사하여 보관합니다.

URL 형식 예시:
```
https://script.google.com/macros/s/AKfycbx.../exec
```

**주의:** "모든 사용자" 접근 허용을 하지 않으면, 메이크샵 방문자의 브라우저에서 GAS를 호출할 수 없습니다. 반드시 "모든 사용자"로 설정하세요.

### 4-6. 배포 URL 브라우저 테스트

배포가 성공했는지 확인합니다:

1. 브라우저 주소창에 배포 URL을 직접 입력:
   ```
   https://script.google.com/macros/s/AKfycbx.../exec?count=5
   ```
2. JSON 응답이 표시되어야 합니다:
   ```json
   {
     "status": "success",
     "items": [
       {
         "id": "dQw4w9WgXcQ",
         "title": "영상 제목...",
         "tags": ["압화", "pressed flower", ...],
         "viewCount": "12345",
         ...
       }
     ],
     "categoryKeywords": { "압화": "압화", "pressed": "압화", ... },
     "categoryProducts": { "압화": [...], "default": [...] },
     "timestamp": "2026-02-20T..."
   }
   ```

확인 항목:
- `status`가 `"success"`인가?
- `items` 배열에 영상이 있는가?
- 각 영상에 `tags`, `viewCount`가 포함되어 있는가?
- `categoryKeywords`에 등록한 키워드가 있는가?
- `categoryProducts`에 `default` 포함 카테고리별 상품이 있는가?

### Step 2 완료 체크리스트

- [ ] GAS 프로젝트에 `youtube-proxy-v3.gs` 코드를 붙여넣었는가?
- [ ] 스크립트 속성에 `YOUTUBE_API_KEY`를 설정했는가?
- [ ] 스크립트 속성에 `SPREADSHEET_ID`를 설정했는가?
- [ ] `checkConfig()` 실행 시 `[OK]` 표시되는가?
- [ ] 웹 앱 배포 시 "모든 사용자" 접근을 허용했는가?
- [ ] 브라우저에서 배포 URL 호출 시 JSON 응답이 정상인가?
- [ ] 배포 URL을 복사해 두었는가?

---

## 5. Step 3: 프론트엔드 배포

### 5-1. js.js의 GAS URL 교체

`js.js` 파일을 텍스트 편집기로 열고, 상단의 CONFIG 섹션에서 `gasUrl`을 실제 배포 URL로 교체합니다:

**변경 전:**
```javascript
var CONFIG = {
    // GAS 프록시 URL (배포 후 실제 URL로 교체)
    gasUrl: 'https://script.google.com/macros/s/YOUR_DEPLOYED_GAS_URL/exec',
```

**변경 후:**
```javascript
var CONFIG = {
    // GAS 프록시 URL (배포 후 실제 URL로 교체)
    gasUrl: 'https://script.google.com/macros/s/AKfycbx실제URL.../exec',
```

**주의:** URL 앞뒤의 작은따옴표(`'`)를 지우지 마세요. URL만 교체합니다.

### 5-2. 메이크샵 관리자 접속

1. 메이크샵 관리자 페이지 접속: `https://foreverlove.co.kr/admin/`
2. 로그인
3. 좌측 메뉴: **디자인 관리** > **디자인 보관함** (또는 **메인페이지 편집**)
4. 현재 사용 중인 디자인의 **메인페이지** 편집 화면으로 이동

### 5-3. HTML 탭에 Index.html 붙여넣기

1. 메인페이지 편집기에서 **HTML 탭** 클릭
2. 기존 v3 유튜브 섹션을 찾습니다:
   ```html
   <!--s: section_youtube-->
   ... (기존 v3 코드)
   <!--e: section_youtube-->
   ```
3. 기존 v3 코드를 **전체 삭제**
4. 같은 위치에 `Index.html`의 내용을 **전체 붙여넣기**:
   ```html
   <!--s: section_youtube (v4 카테고리 자동매칭) -->
   <section class="youtube-v4-section" id="youtube-v4-section">
       ...
   </section>
   <!--e: section_youtube -->
   ```

**주의:** v3의 HTML을 삭제하고 v4 HTML로 교체하는 것입니다. CSS 클래스가 완전히 다르므로 v3 코드를 남겨두면 안 됩니다.

### 5-4. CSS 탭에 css.css 붙여넣기

1. 메인페이지 편집기에서 **CSS 탭** 클릭
2. 기존 v3 유튜브 관련 CSS를 찾아 **삭제**합니다:
   - `.youtube-section-v3`로 시작하는 모든 스타일
   - v3 관련 미디어 쿼리
3. `css.css`의 내용을 **전체 붙여넣기**
   - 기존의 다른 CSS(유튜브 외 섹션)는 그대로 두고, v4 CSS를 추가합니다

> v4 CSS는 `.youtube-v4-section`으로 완전히 스코핑되어 있으므로 기존 스타일과 충돌하지 않습니다.

### 5-5. JS 탭에 js.js 붙여넣기

1. 메인페이지 편집기에서 **JS 탭** 클릭
2. 기존 v3 유튜브 관련 JS를 찾아 **삭제**합니다:
   - `loadYouTube()`, `renderYouTube()`, `playVideo()`, `toggleProducts()` 등
   - v3의 IIFE 블록 전체
3. `js.js`의 내용을 **전체 붙여넣기** (5-1에서 GAS URL을 교체한 버전)
   - 기존의 다른 JS(유튜브 외 기능)는 그대로 둡니다

> v4 JS는 IIFE `(function() { ... })();` 패턴으로 감싸져 있어 전역 변수를 오염시키지 않습니다. 유일하게 전역에 노출되는 것은 `window.clearYouTubeV4Cache` 함수뿐입니다.

### 5-6. 저장

1. **저장** 버튼 클릭
2. "데이터 수정 성공" 메시지 확인

**주의:** 만약 "데이터 수정 실패" 에러가 발생하면, JS 코드에 `${변수}` 형태의 템플릿 리터럴이 포함되어 있을 가능성이 있습니다. v4 코드는 이 문제를 방지하기 위해 모든 문자열을 `+` 연결로 처리하고 있으므로, 직접 수정한 부분이 없다면 이 에러가 발생하지 않아야 합니다. 만약 발생한다면 7장 트러블슈팅을 참고하세요.

### 5-7. 외부 라이브러리 확인

v4는 다음 외부 라이브러리가 필요합니다. 메이크샵 메인페이지에 이미 로드되어 있는지 확인하세요:

- **jQuery**: 메이크샵 D4에 기본 탑재 (별도 추가 불필요)
- **Swiper**: 하단 영상 슬라이더에 사용

Swiper가 로드되어 있지 않다면, HTML 탭 상단 또는 하단에 CDN을 추가합니다:

```html
<!-- Swiper CSS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css">
<!-- Swiper JS -->
<script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>
```

> 기존 v3에서 Swiper를 사용하고 있었다면 이미 로드되어 있을 것입니다.

### Step 3 완료 체크리스트

- [ ] `js.js`의 `CONFIG.gasUrl`을 실제 배포 URL로 교체했는가?
- [ ] 기존 v3의 HTML/CSS/JS를 완전히 제거했는가?
- [ ] HTML 탭에 `Index.html` 내용을 붙여넣었는가?
- [ ] CSS 탭에 `css.css` 내용을 붙여넣었는가?
- [ ] JS 탭에 `js.js` 내용을 붙여넣었는가?
- [ ] 저장 시 "데이터 수정 성공" 메시지가 표시되었는가?
- [ ] Swiper CDN이 페이지에 로드되어 있는가?

---

## 6. Step 4: 동작 확인

### 6-1. GAS URL 직접 호출 테스트

브라우저 주소창에서 배포 URL을 직접 호출하여 백엔드가 정상인지 확인합니다:

```
https://script.google.com/macros/s/AKfycbx.../exec?count=5
```

정상 응답 예시:
```json
{
  "status": "success",
  "items": [
    {
      "id": "영상ID",
      "title": "영상 제목",
      "description": "영상 설명...",
      "tags": ["압화", "pressed flower", "DIY"],
      "publishedAt": "2026-02-18T09:00:00Z",
      "viewCount": "1234",
      "thumbnail": "https://img.youtube.com/vi/영상ID/mqdefault.jpg"
    }
  ],
  "categoryKeywords": { "압화": "압화", "pressed": "압화" },
  "categoryProducts": {
    "압화": [{ "branduid": "1001", "name": "압화 스타터 키트", "price": "35000", "image": "..." }],
    "default": [{ "branduid": "9001", "name": "베스트셀러 1", "price": "28000", "image": "..." }]
  },
  "timestamp": "2026-02-20T12:00:00.000Z"
}
```

### 6-2. 메인페이지 새로고침 후 확인

1. `https://foreverlove.co.kr` 메인페이지 접속
2. 유튜브 섹션까지 스크롤
3. 확인 항목:
   - 스켈레톤 shimmer 로딩 UI가 잠시 표시되었다가 영상이 로드되는가?
   - 메인 영상 썸네일이 표시되는가? (iframe이 아닌 이미지)
   - 메인 썸네일 클릭 시 YouTube 영상이 자동재생되는가?
   - 우측(PC) 또는 하단(모바일)에 관련 상품이 표시되는가?
   - 카테고리 배지가 영상 좌측 하단에 표시되는가?
   - 하단 슬라이더에 나머지 영상들이 표시되는가?
   - 슬라이더 카드 클릭 시 메인 영상이 교체되는가?
   - 영상 교체 시 관련 상품도 함께 변경되는가?

### 6-3. 캐시 확인

1. 브라우저 개발자 도구 열기 (F12)
2. **Application** 탭 > **Local Storage** > 사이트 도메인
3. `yt_v4_data`와 `yt_v4_time` 키가 생성되었는지 확인
4. 페이지를 새로고침하면 네트워크 탭에 GAS 요청이 발생하지 않아야 함 (캐시 사용)

### 6-4. 캐시 초기화 방법

데이터를 변경한 후 즉시 반영하고 싶을 때:

1. 브라우저 개발자 도구 > **Console** 탭
2. 다음 명령어 입력 후 Enter:
   ```javascript
   window.clearYouTubeV4Cache()
   ```
3. 페이지가 자동으로 새로고침되며 최신 데이터를 다시 로드합니다

### Step 4 완료 체크리스트

- [ ] GAS URL 직접 호출 시 `status: "success"` 응답을 받는가?
- [ ] 메인페이지에서 스켈레톤 UI가 잠시 표시 후 영상이 로드되는가?
- [ ] 메인 영상 클릭 시 자동재생되는가?
- [ ] 관련 상품이 카테고리에 맞게 표시되는가?
- [ ] 하단 슬라이더가 동작하는가?
- [ ] localStorage에 캐시 키가 생성되었는가?
- [ ] `window.clearYouTubeV4Cache()`가 정상 동작하는가?

---

## 7. 트러블슈팅

### 7-1. GAS 배포 URL이 바뀐 경우

**증상**: 메인페이지에서 영상이 로드되지 않고 에러 메시지 표시

**원인**: GAS 코드를 수정하고 새로 배포하면 URL이 바뀔 수 있습니다.

**해결 방법**:
1. [script.google.com](https://script.google.com) 접속
2. 프로젝트 열기 > **배포** > **배포 관리**
3. 현재 활성 배포의 URL 확인
4. URL이 변경되었다면:
   - `js.js`의 `CONFIG.gasUrl`을 새 URL로 교체
   - 메이크샵 JS 탭에 다시 붙여넣기
   - 저장

**예방 방법**: GAS 코드를 수정할 때는 "새 배포"가 아닌 기존 배포를 **수정** (연필 아이콘)하면 URL이 유지됩니다.
- **배포** > **배포 관리** > 연필 아이콘 > 버전: **새 버전** 선택 > **배포**

### 7-2. YouTube API 할당량 초과 시

**증상**: GAS 응답에 영상의 `tags`와 `viewCount`가 비어 있음 (빈 배열 `[]`, `"0"`)

**원인**: YouTube Data API v3의 일일 할당량(10,000 유닛)이 초과됨

**해결 방법**:
1. 할당량은 태평양 시간 자정(한국 시간 오후 4시)에 초기화됩니다
2. GAS의 CacheService가 5분 캐시를 적용하므로, 정상적인 사용에서는 할당량 초과가 거의 발생하지 않습니다
3. 만약 초과되면 **RSS 폴백**이 자동 작동하여 영상 목록은 정상 표시됩니다 (태그와 조회수만 없음)
4. 카테고리 매칭은 태그 없이 제목과 설명만으로도 동작합니다

**근본 해결**:
- [Google Cloud Console](https://console.cloud.google.com/) > **API 및 서비스** > **대시보드** > YouTube Data API v3
- 할당량 사용량 확인
- 필요 시 할당량 증가 요청

### 7-3. 카테고리 매칭이 안 될 때

**증상**: 모든 영상이 "인기 상품"(default)만 표시, 카테고리 배지가 표시되지 않음

**확인 순서**:

1. **Google Sheets 키워드 확인**:
   - "카테고리키워드" 시트에 키워드가 올바르게 입력되었는가?
   - 키워드 앞뒤에 불필요한 공백이 있지 않은가?

2. **영상 메타데이터 확인**:
   - GAS URL을 브라우저에서 호출하여 영상의 `title`, `description`, `tags`를 확인
   - 영상의 제목/설명/태그에 등록한 키워드가 실제로 포함되어 있는가?

3. **대소문자**:
   - 매칭은 대소문자를 구분하지 않습니다 (내부적으로 소문자로 변환)
   - "Pressed Flower"와 "pressed"는 모두 매칭됩니다

4. **캐시 초기화**:
   - 키워드를 수정한 후 GAS 캐시(5분)와 프론트엔드 캐시(24시간)를 모두 초기화해야 합니다
   - GAS 캐시: GAS 편집기에서 `clearCache()` 함수 실행
   - 프론트엔드 캐시: 브라우저 콘솔에서 `window.clearYouTubeV4Cache()` 실행

### 7-4. 상품이 표시되지 않을 때

**증상**: 영상은 나오지만 관련 상품 영역이 비어 있음 ("관련 상품이 준비 중입니다")

**확인 순서**:

1. **Google Sheets 상품 데이터 확인**:
   - "카테고리상품" 시트에 데이터가 있는가?
   - 카테고리명이 "카테고리키워드" 시트의 카테고리와 정확히 일치하는가?
   - 예: 키워드 시트에 "압화"인데 상품 시트에 "압화 "처럼 공백이 포함되면 매칭 실패

2. **default 카테고리 확인**:
   - "카테고리상품" 시트에 `default` 카테고리 행이 있는가?
   - `default`는 소문자로 정확히 입력해야 합니다

3. **이미지 URL 확인**:
   - E열의 이미지 URL이 실제로 접근 가능한 URL인가?
   - 메이크샵 CDN URL이 올바른 형태인가?

4. **branduid 확인**:
   - B열의 branduid가 실제 메이크샵 상품의 branduid와 일치하는가?
   - 상품 링크 클릭 시 올바른 상품 페이지로 이동하는가?

### 7-5. 메이크샵 저장 실패 시 (템플릿 리터럴 문제)

**증상**: JS 탭에 코드를 붙여넣고 저장하면 "데이터 수정 실패" 에러 발생

**원인**: 메이크샵 D4 엔진은 `${변수}`를 치환코드로 인식합니다. JS의 템플릿 리터럴과 충돌합니다.

**해결 방법**:
1. v4 코드는 이미 모든 문자열을 `'문자열' + 변수 + '문자열'` 형태로 처리하고 있습니다
2. 만약 코드를 직접 수정하면서 실수로 `${}` 를 사용했다면:
   - JS 코드에서 `` `문자열 ${변수}` `` 패턴을 검색
   - `'문자열 ' + 변수` 형태로 변경
   - 또는 불가피하게 `$`를 써야 한다면 `\$` 로 이스케이프

**주의:** `let`과 `const`도 일부 메이크샵 환경에서 문제를 일으킬 수 있습니다. v4 코드는 모두 `var`를 사용하고 있습니다. 코드 수정 시에도 `var`만 사용하세요.

### 7-6. Swiper가 동작하지 않을 때

**증상**: 하단 슬라이더가 가로로 나열되지 않고 세로로 쌓임, 좌우 넘기기 불가

**확인 순서**:
1. 브라우저 개발자 도구 > **Console** 탭에서 `Swiper is not defined` 에러 확인
2. Swiper CDN이 제대로 로드되는지 **Network** 탭에서 확인
3. Swiper CSS와 JS가 모두 로드되어야 합니다:
   ```html
   <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css">
   <script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>
   ```
4. Swiper JS는 v4의 `js.js`보다 먼저 로드되어야 합니다 (HTML 탭에서 위에 위치)

### 7-7. CORS 에러

**증상**: 브라우저 콘솔에 `Access-Control-Allow-Origin` 에러 표시

**원인**: GAS 웹 앱은 기본적으로 CORS를 허용합니다. 이 에러가 발생한다면:

1. GAS 배포 설정에서 "모든 사용자" 접근이 허용되었는지 확인
2. GAS URL이 `/exec`으로 끝나는지 확인 (`/dev`가 아닌)
3. HTTPS인지 확인 (HTTP는 차단됨)

---

## 8. 유지보수

### 8-1. 새 카테고리/상품 추가 방법

v4의 가장 큰 장점은 **코드 수정 없이 Google Sheets만 편집하면 됩니다**.

**새 카테고리 추가 예시 - "디퓨저" 카테고리**:

1. Google Sheets > "카테고리키워드" 시트에 행 추가:

   | 키워드 | 카테고리 |
   |--------|---------|
   | 디퓨저 | 디퓨저 |
   | diffuser | 디퓨저 |

2. Google Sheets > "카테고리상품" 시트에 행 추가:

   | 카테고리 | branduid | 상품명 | 가격 | 이미지URL |
   |---------|---------|--------|------|----------|
   | 디퓨저 | 3001 | 디퓨저 키트 | 25000 | https://... |
   | 디퓨저 | 3002 | 디퓨저 오일 세트 | 18000 | https://... |

3. GAS 캐시 초기화 (변경 사항을 빠르게 반영하려면):
   - GAS 편집기에서 `clearCache()` 함수 실행

4. 프론트엔드 캐시 초기화:
   - 브라우저 콘솔에서 `window.clearYouTubeV4Cache()` 실행

> 캐시를 초기화하지 않아도, GAS 캐시는 5분 후, 프론트엔드 캐시는 24시간 후 자동으로 갱신됩니다.

**기존 상품 수정 방법**:
- Google Sheets에서 해당 행의 상품명, 가격, 이미지URL 등을 직접 수정
- 코드 변경이나 재배포는 필요 없음

### 8-2. GAS 캐시 수동 초기화

Google Sheets의 키워드나 상품 데이터를 수정한 후, 변경사항을 즉시 반영하려면:

1. [script.google.com](https://script.google.com) 접속
2. 프로젝트 열기
3. 함수 선택 드롭다운에서 **clearCache** 선택
4. **실행** 버튼 클릭
5. 실행 로그에서 확인:
   ```
   [캐시 삭제] 모든 통합 캐시가 삭제되었습니다
   ```

### 8-3. GAS 코드 수정 시 재배포 방법

GAS 코드 자체를 수정해야 할 때 (예: 채널 ID 변경, 캐시 시간 조정 등):

1. GAS 편집기에서 코드 수정
2. **배포** > **배포 관리**
3. 기존 배포 옆 **연필 아이콘** (수정) 클릭
4. **버전** 드롭다운에서 **새 버전** 선택
5. **배포** 버튼 클릭

**주의:** "새 배포"가 아닌 "배포 관리 > 수정"을 사용해야 URL이 유지됩니다. "새 배포"를 하면 URL이 바뀌고, `js.js`의 `CONFIG.gasUrl`도 수정해야 합니다.

### 8-4. 버전 롤백 (v3로 복구하기)

v4에 문제가 발생하여 v3로 되돌려야 할 경우:

1. 메이크샵 관리자 > 메인페이지 편집
2. **HTML 탭**: v4의 `<section class="youtube-v4-section">...</section>` 삭제하고, v3의 `fullcode.html` 내용으로 교체
3. **CSS 탭**: v4 CSS (`.youtube-v4-section`으로 시작하는 모든 스타일) 삭제하고, v3 CSS로 교체
4. **JS 탭**: v4 JS (IIFE 블록 전체) 삭제하고, v3 JS로 교체
5. 저장

v3 파일 위치: `유튜브 자동화/현재-배포/` 폴더

> v3의 GAS URL은 기존에 사용하던 URL을 그대로 사용하면 됩니다 (v3 GAS 프로젝트가 여전히 배포 중이라면).

### 8-5. 모니터링 포인트

정기적으로 확인하면 좋은 항목:

- **YouTube API 할당량**: 월 1회 [Google Cloud Console](https://console.cloud.google.com/) 대시보드에서 확인
- **Google Sheets 데이터**: 새 영상 카테고리에 맞는 키워드/상품이 등록되어 있는지 확인
- **GAS 실행 로그**: [script.google.com](https://script.google.com) > 프로젝트 > 좌측 **실행** 탭에서 에러 로그 확인

---

## 부록: 파일별 핵심 구조 참고

### youtube-proxy-v3.gs (GAS 백엔드, 517줄)

```
doGet(e)                        GET 요청 엔트리포인트
  └── getIntegratedDataWithCache()  통합 데이터 (캐시 적용)
        ├── getLatestVideos()        영상 목록
        │     ├── getVideoIdsFromRSS()      RSS에서 ID 추출
        │     ├── getVideoDetailsWithTags()  Data API로 상세 정보
        │     └── getVideosFromRSSOnly()     폴백 (API 실패 시)
        ├── getCategoryKeywords()    Sheets 키워드 테이블
        └── getCategoryProducts()    Sheets 상품 테이블

clearCache()                    캐시 수동 삭제
checkConfig()                   설정 확인 (디버깅용)
testIntegrated()                통합 테스트
```

### js.js (프론트엔드, 642줄)

```
IIFE 패턴 (전역 변수 오염 방지)
├── CONFIG                      설정 (gasUrl, 캐시 시간 등)
├── escapeHTML() / escapeAttr() 보안 유틸리티
├── formatViewCount()           조회수 포맷 (1.5만 조회)
├── formatDate()                날짜 포맷 (3일 전)
├── formatPrice()               가격 포맷 (35,000원)
├── autoMatchCategory()         카테고리 자동매칭 (핵심)
├── getProductsForCategory()    카테고리별 상품 조회
├── init() / loadData()         초기화 + 데이터 로딩
├── renderAll()
│     ├── renderMainVideo()     메인 영상 (썸네일 → iframe)
│     ├── renderProducts()      관련 상품 패널
│     └── renderSlider()        하단 Swiper 슬라이더
├── switchVideo()               영상 전환
├── toggleProductPanel()        모바일 상품 토글
├── showSkeleton()              로딩 UI
├── showError()                 에러 UI
└── window.clearYouTubeV4Cache  캐시 초기화 (전역)
```

### css.css (스타일시트, 780줄)

```
.youtube-v4-section             섹션 컨테이너 (스코핑 루트)
├── .ytv4-layout                메인 레이아웃 (flex)
├── .ytv4-main-video            메인 영상 카드
│     ├── .ytv4-thumb-wrap      썸네일 (클릭 전)
│     ├── .ytv4-iframe-wrap     iframe (클릭 후)
│     ├── .ytv4-play-btn        재생 버튼
│     ├── .ytv4-badge-new       NEW 배지
│     └── .ytv4-badge-category  카테고리 배지
├── .ytv4-product-panel         관련 상품 사이드바
│     ├── .ytv4-product-toggle  토글 헤더 (모바일)
│     ├── .ytv4-product-grid    상품 2열 그리드
│     └── .ytv4-product-card    상품 카드
├── .ytv4-slider-section        하단 슬라이더
│     ├── .ytv4-slide           슬라이더 카드
│     └── Swiper 컨트롤         페이지네이션, 네비게이션
├── .ytv4-skeleton / .ytv4-shimmer  스켈레톤 로딩 UI
└── @media (min-width: 768px)   데스크톱 반응형
    @media (min-width: 1024px)  대형 화면 반응형
```

### Index.html (마크업, 37줄)

```html
<!--s: section_youtube (v4 카테고리 자동매칭) -->
<section class="youtube-v4-section" id="youtube-v4-section">
    <div class="main-container">
        <div class="section-title">...</div>
        <div class="ytv4-layout">
            <div class="ytv4-main-video"><!-- JS 삽입 --></div>
            <div class="ytv4-product-panel"><!-- JS 삽입 --></div>
        </div>
        <div class="ytv4-slider-section">
            <div class="swiper-container ytv4-slider">
                <div class="swiper-wrapper ytv4-slider-wrapper"><!-- JS 삽입 --></div>
            </div>
        </div>
    </div>
</section>
<!--e: section_youtube -->
```

---

## 최종 배포 체크리스트

아래 모든 항목이 체크되면 배포가 완료된 것입니다.

### 사전 준비
- [ ] YouTube Data API v3 키를 발급받았다
- [ ] Google Sheets 스프레드시트를 생성하고 ID를 확인했다
- [ ] GAS 프로젝트를 생성했다

### Google Sheets
- [ ] "카테고리키워드" 시트에 키워드-카테고리 매핑 데이터를 입력했다
- [ ] "카테고리상품" 시트에 카테고리-상품 매핑 데이터를 입력했다
- [ ] "default" 카테고리에 상품을 최소 1개 이상 등록했다

### GAS 백엔드
- [ ] `youtube-proxy-v3.gs` 코드를 GAS 프로젝트에 붙여넣었다
- [ ] 스크립트 속성에 `YOUTUBE_API_KEY`를 설정했다
- [ ] 스크립트 속성에 `SPREADSHEET_ID`를 설정했다
- [ ] `checkConfig()` 실행 결과가 정상이다
- [ ] 웹 앱을 "모든 사용자" 접근으로 배포했다
- [ ] 브라우저에서 배포 URL 호출 시 정상 JSON 응답을 확인했다

### 프론트엔드
- [ ] `js.js`의 `CONFIG.gasUrl`을 실제 배포 URL로 교체했다
- [ ] 메이크샵 HTML 탭에 `Index.html`을 붙여넣었다
- [ ] 메이크샵 CSS 탭에 `css.css`를 붙여넣었다 (기존 v3 CSS 제거)
- [ ] 메이크샵 JS 탭에 `js.js`를 붙여넣었다 (기존 v3 JS 제거)
- [ ] 저장 시 "데이터 수정 실패" 에러가 없다
- [ ] Swiper CDN이 로드되어 있다

### 동작 확인
- [ ] 메인페이지에서 유튜브 섹션이 정상 표시된다
- [ ] 메인 영상 클릭 시 자동재생된다
- [ ] 카테고리 배지가 매칭된 영상에 표시된다
- [ ] 관련 상품이 카테고리에 맞게 표시된다
- [ ] 하단 슬라이더가 동작한다
- [ ] 모바일에서 관련 상품 토글이 동작한다
- [ ] `window.clearYouTubeV4Cache()`가 정상 동작한다
